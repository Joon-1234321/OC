<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ë‹¨ì–´ ìŠ¤í”¼ë“œí€´ì¦ˆ â€” ë¼ìš´ë“œë³„ ì¶œì œ(ëœ» ì „ë¶€â†’ìŠ¤í  ì „ë¶€â€¦)</title>
<style>
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,sans-serif;background:#0b1220;color:#e5e7eb}
  header{position:sticky;top:0;background:#0b1220cc;border-bottom:1px solid #ffffff22;backdrop-filter:blur(6px);z-index:10}
  .wrap{max-width:980px;margin:0 auto;padding:12px 14px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .stat{background:#ffffff10;border:1px solid #ffffff22;border-radius:10px;padding:6px 10px}
  button,select,input{background:#111a2e;border:1px solid #ffffff22;color:#e5e7eb;border-radius:10px;padding:8px 10px;font-weight:800;cursor:pointer}
  button.primary{background:#2b3a68;border-color:#2b3a68}
  main{max-width:980px;margin:12px auto;padding:0 14px}
  .card{background:linear-gradient(180deg,#0e1630,#0b1220);border:1px solid #ffffff22;border-radius:14px;padding:18px;min-height:170px;box-shadow:0 10px 30px #0007}
  .q-meaning{font-size:26px;font-weight:900;color:#cffafe}
  .muted{color:#94a3b8}
  .inputrow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  #answer{flex:1;background:#0b1326;border:1px solid #ffffff24;border-radius:10px;padding:12px 14px;color:#e5e7eb;font-weight:900;font-size:18px}
  details{margin-top:12px;background:#0b1326;border:1px solid #ffffff18;border-radius:12px;overflow:hidden}
  summary{padding:10px 12px;font-weight:900;cursor:pointer}
  textarea{width:100%;min-height:120px;background:#0f172a;color:#e5e7eb;border:1px solid #ffffff22;border-radius:10px;padding:10px;font-weight:700}
  .timerbar{height:10px;background:#ffffff14;border:1px solid #ffffff1f;border-radius:999px;overflow:hidden;margin-bottom:10px}
  .timerbar>div{height:100%;background:#7dd3fc;width:100%}
  .shake{animation:shake .22s linear}
  @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}
  .pill{background:#ffffff10;border:1px solid #ffffff22;border-radius:999px;padding:6px 10px;font-weight:800}
  .list{max-height:220px;overflow:auto;background:#0b1220;border:1px solid #ffffff22;border-radius:10px;padding:8px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div style="font-weight:900">âš¡ ë‹¨ì–´ ìŠ¤í”¼ë“œí€´ì¦ˆ â€” ë¼ìš´ë“œë³„ ì¶œì œ(ëœ» ì „ë¶€â†’ìŠ¤í  ì „ë¶€â€¦)</div>
      <div class="row">
        <div class="stat">ì ìˆ˜ <b id="score">0</b></div>
        <div class="stat">ì§„í–‰ <b id="progress">0/0</b></div>
        <div class="stat">ë‚¨ì€ì‹œê°„ <b id="time">60</b>s</div>
        <div class="pill">ì´ ë‹¨ì–´ <b id="totalItems">0</b>ê°œ</div>
      </div>
    </div>
    <div class="row" style="margin-top:6px">
      <button id="startBtn" class="primary">â–¶ ì‹œì‘</button>
      <button id="previewBtn">ğŸ‘ ë¯¸ë¦¬ë³´ê¸°</button>
      <button id="skipBtn">â­ ìŠ¤í‚µ</button>
      <button id="restartBtn">âŸ² ì¬ì‹œì‘</button>
      <label>ë¼ìš´ë“œ
        <select id="roundTime"><option value="45">45s</option><option value="60" selected>60s</option><option value="90">90s</option></select>
      </label>
      <label>ì´ë²ˆ ë¼ìš´ë“œ ì¶œì œ
        <select id="startMode">
          <option value="e2k" selected>ëœ» ì“°ê¸°(ì˜â†’í•œ)</option>
          <option value="k2e">ìŠ¤í  ì“°ê¸°(í•œâ†’ì˜)</option>
        </select>
      </label>
      <label><input type="checkbox" id="ttsToggle" checked> ì •ë‹µ TTS(ì˜ì–´ë§Œ)</label>
      <label><input type="checkbox" id="countToggle" checked> 3-2-1</label>
      <button id="peekBtn">ğŸ“ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°</button>
    </div>
  </div>
</header>

<main>
  <div class="timerbar"><div id="bar"></div></div>

  <div class="card" id="card">
    <div class="q-meaning" id="meaning">ë¬¸ì œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
    <div class="muted" id="instruction">ì´ë²ˆ ë¼ìš´ë“œëŠ” ì„ íƒí•œ ëª¨ë“œ(ëœ»ì“°ê¸°/ìŠ¤í ì“°ê¸°)ë¡œ <b>ì „ì²´ ë¬¸í•­</b>ì´ ì¶œì œë©ë‹ˆë‹¤.</div>
    <div class="inputrow">
      <input id="answer" type="text" autocomplete="off" placeholder="ì—¬ê¸°ì— ë‹µ ì…ë ¥â€¦" />
      <button id="submitBtn" class="primary">í™•ì¸</button>
    </div>
    <div id="hint" class="muted" style="display:none"></div>
  </div>

  <details>
    <summary>ğŸ“š ë‹¨ì–´ í¸ì§‘ â€” ë³µìˆ˜ì •ë‹µ ê·œì¹™: <code>ì˜ì–´1|ì˜ì–´2 = ëœ»1|ëœ»2</code> (ì‰¼í‘œë„ êµ¬ë¶„ì / <b>= ì—†ì´ ê³µë°±ë§Œìœ¼ë¡œë„ OK</b>)</summary>
    <div style="padding:10px; display:grid; gap:10px">
      <textarea id="bank">join ê°€ì…í•˜ë‹¤
send ë³´ë‚´ë‹¤
DM ë‹¤ì´ë ‰íŠ¸ ë©”ì‹œì§€, ë‹¤ì´ë ‰íŠ¸ ë©”ì„¸ì§€
write ì“°ë‹¤, ê¸°ë¡í•˜ë‹¤
subscribe to êµ¬ë…í•˜ë‹¤
follow íŒ”ë¡œìš°í•˜ë‹¤, ë”°ë¥´ë‹¤
share ê³µìœ í•˜ë‹¤
post ê²Œì‹œí•˜ë‹¤
channel ì±„ë„
account ê³„ì •, ê³„ì¢Œ
comment ëŒ“ê¸€, ë…¼í‰</textarea>
      <div class="row">
        <button id="applyBtn" class="primary">ë‹¨ì–´ ì ìš©</button>
        <div class="muted">ì˜ˆ: <code>color|colour=ìƒ‰</code> / <code>USB|flash drive=USB|ìœ ì—ìŠ¤ë¹„</code></div>
      </div>
    </div>
  </details>

  <details>
    <summary>ğŸ§ª íŒŒì‹± ê²°ê³¼(ì§„ë‹¨ìš©)</summary>
    <div class="list" id="debugList"></div>
  </details>
</main>

<script>
(function(){
  // ===== DOM =====
  var meaning=document.getElementById('meaning');
  var instruction=document.getElementById('instruction');
  var answer=document.getElementById('answer');
  var submitBtn=document.getElementById('submitBtn');
  var skipBtn=document.getElementById('skipBtn');
  var startBtn=document.getElementById('startBtn');
  var restartBtn=document.getElementById('restartBtn');
  var previewBtn=document.getElementById('previewBtn');
  var countToggle=document.getElementById('countToggle');
  var ttsToggle=document.getElementById('ttsToggle');
  var roundTimeSel=document.getElementById('roundTime');
  var startModeSel=document.getElementById('startMode');
  var bankTA=document.getElementById('bank');
  var applyBtn=document.getElementById('applyBtn');
  var scoreEl=document.getElementById('score');
  var progressEl=document.getElementById('progress');
  var timeEl=document.getElementById('time');
  var bar=document.getElementById('bar');
  var card=document.getElementById('card');
  var hint=document.getElementById('hint');
  var totalItemsEl=document.getElementById('totalItems');
  var debugList=document.getElementById('debugList');
  var peekBtn=document.getElementById('peekBtn');

  // ===== STATE =====
  var items=[], queue=[];
  var idx=0;
  var score=0, solved=0, missed=0;
  var timer=null, totalSec=60, leftSec=60;
  var running=false;
  var nextRoundMode='e2k'; // round toggles after each end

  // ===== helpers (robust parsing) =====
  function splitAlts(s){
    var parts = String(s||'').split(/[|,]/);
    var out = [];
    for(var i=0;i<parts.length;i++){
      var t = String(parts[i]).trim();
      if(t) out.push(t);
    }
    return out;
  }
  function normalizeTextArea(raw){
    return String(raw||'')
      .replace(/\r\n/g, '\n')
      .replace(/\r/g, '\n')
      .replace(/\u2028/g, '\n')
      .replace(/\u2029/g, '\n');
  }
  function looksKorean(s){ return /[ê°€-í£]/.test(String(s||'')); }

  // Smart split: if '=' absent, split at first Hangul boundary.
  function splitEngKorSmart(line){
    var i=0, s=String(line);
    for(i=0;i<s.length;i++){
      var ch=s.charAt(i);
      if(/[ê°€-í£]/.test(ch)){ break; }
    }
    if(i>0 && i<s.length){
      var left=s.slice(0,i).trim();
      var right=s.slice(i).trim();
      if(left){ return {left:left, right:right}; }
    }
    // fallback: first whitespace split
    var m = s.match(/^(.+?)\s+(.+)$/);
    if(m) return {left:m[1].trim(), right:m[2].trim()};
    return {left:s.trim(), right:s.trim()};
  }

  function parseBank(){
    items=[];
    try{
      var raw = normalizeTextArea(bankTA.value);
      var lines = raw.split('\n');
      for(var i=0;i<lines.length;i++){
        var line = String(lines[i]||'').trim();
        if(!line) continue;

        var eq = line.indexOf('=');
        var left, right;
        if(eq>0){
          left = line.slice(0,eq).trim();
          right = line.slice(eq+1).trim();
        } else {
          var pair = splitEngKorSmart(line);
          left = pair.left; right = pair.right;
        }

        var engs = splitAlts(left);
        var kors = splitAlts(right);
        if(!engs.length) continue;

        var engPrim = engs[0];
        var korPrim = kors.length ? kors[0] : engPrim;
        var engAlts = engs.slice(1);
        var korAlts = kors.slice(1);

        items.push({ engPrim:engPrim, korPrim:korPrim, engAlts:engAlts, korAlts:korAlts });
      }
    }catch(e){
      items=[]; console.log('parse error', e);
    }
    totalItemsEl.textContent = String(items.length);
    renderDebug();
  }

  function renderDebug(){
    debugList.innerHTML='';
    if(!items.length){ debugList.textContent='í•­ëª© ì—†ìŒ'; return; }
    for(var i=0;i<items.length;i++){
      var it=items[i];
      var d=document.createElement('div');
      d.textContent=(i+1)+'. '+it.engPrim+' ['+(it.engAlts.join(' | ')||'-')+'] â€” '+it.korPrim+' ['+(it.korAlts.join(' | ')||'-')+']';
      debugList.appendChild(d);
    }
  }

  function shuffle(arr){
    for(var i=arr.length-1;i>0;i--){
      var j=Math.floor(Math.random()*(i+1));
      var t=arr[i]; arr[i]=arr[j]; arr[j]=t;
    }
  }

  // Build queue with ONE mode for the whole round
  function buildQueue(roundMode){
    queue = items.slice(0);
    shuffle(queue);
    for(var i=0;i<queue.length;i++){
      queue[i] = Object.assign({}, queue[i], { mode: roundMode });
    }
  }

  function normalizeEng(s){ return String(s||'').toLowerCase().trim(); }
  function normalizeKor(s){ return String(s||'').replace(/\s+/g,'').trim(); }
  function anyMatchEng(input, prim, alts){
    var v = normalizeEng(input);
    if(v===normalizeEng(prim)) return true;
    for(var i=0;i<alts.length;i++){ if(v===normalizeEng(alts[i])) return true; }
    return false;
  }
  function anyMatchKor(input, prim, alts){
    var v = normalizeKor(input);
    if(v===normalizeKor(prim)) return true;
    for(var i=0;i<alts.length;i++){ if(v===normalizeKor(alts[i])) return true; }
    return false;
  }

  // TTS (English only on correct)
  function speakEnglish(word){
    try{
      if(!ttsToggle.checked) return;
      if(!('speechSynthesis' in window)) return;
      try{ window.speechSynthesis.cancel(); }catch(e){}
      try{ window.speechSynthesis.resume(); }catch(e){}
      var u = new SpeechSynthesisUtterance('\u200B,' + String(word||''));
      u.rate=0.9; u.pitch=1; u.lang='en-US';
      var vs = speechSynthesis.getVoices();
      for(var i=0;i<vs.length;i++){ if(/en|US|UK/i.test(vs[i].lang)){ u.voice=vs[i]; break; } }
      u.onerror=function(){};
      speechSynthesis.speak(u);
    }catch(e){}
  }

  // UI & flow
  function setProgress(){ progressEl.textContent = String(idx+1) + '/' + String(queue.length); scoreEl.textContent = String(score); }

  function showQ(){
    if(idx>=queue.length){ endRound(); return; }
    var q = queue[idx];
    if(q.mode==='k2e'){
      meaning.textContent = q.korPrim;
      instruction.innerHTML = "<b>ìŠ¤í ë§ ì“°ê¸°</b> â€” í•œêµ­ì–´ ëœ»ì„ ë³´ê³  <b>ì˜ì–´</b>ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
      answer.placeholder = "ì˜ì–´ ìŠ¤í ë§â€¦";
    }else{
      meaning.textContent = q.engPrim;
      instruction.innerHTML = "<b>ëœ» ì“°ê¸°</b> â€” ì˜ì–´ë¥¼ ë³´ê³  <b>í•œêµ­ì–´</b>ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
      answer.placeholder = "í•œêµ­ì–´ ëœ»â€¦";
    }
    hint.style.display='none';
    answer.value='';
    answer.focus();
    setProgress();
  }

  function maskEng(s){
    s=String(s||''); if(s.length<=2) return s;
    var inner=s.slice(1,s.length-1).replace(/[A-Za-z]/g,'_');
    return s.charAt(0)+inner+s.charAt(s.length-1);
  }

  function countdown3(next){
    if(!countToggle.checked){ next(); return; }
    var overlay=document.createElement('div');
    overlay.style.position='fixed'; overlay.style.inset='0';
    overlay.style.display='grid'; overlay.style.placeItems='center';
    overlay.style.background='rgba(0,0,0,.45)'; overlay.style.zIndex='9999';
    var label=document.createElement('div');
    label.style.fontSize='64px'; label.style.fontWeight='900';
    label.style.padding='12px 22px'; label.style.borderRadius='16px';
    label.style.background='rgba(255,255,255,0.08)'; label.style.border='1px solid rgba(255,255,255,0.25)';
    label.textContent='3'; overlay.appendChild(label); document.body.appendChild(overlay);
    var n=3;
    var id=setInterval(function(){
      n--;
      if(n>0){ label.textContent=String(n); }
      else if(n===0){ label.textContent='Start!'; }
      else{ clearInterval(id); if(overlay.parentNode) overlay.parentNode.removeChild(overlay); next(); }
    },1000);
    setTimeout(function(){ try{ next(); }catch(e){} }, 3800);
  }

  function startRound(){
    if(running) return;
    parseBank();
    // decide this round's mode: from select; next time toggle
    var modeWanted = startModeSel.value || nextRoundMode;
    buildQueue(modeWanted);
    nextRoundMode = (modeWanted==='e2k') ? 'k2e' : 'e2k'; // toggle for next round

    idx=0; score=0; solved=0; missed=0;
    totalSec=parseInt(roundTimeSel.value,10)||60; leftSec=totalSec;
    timeEl.textContent=String(leftSec); bar.style.width='100%';
    running=true; startBtn.disabled=true;

    countdown3(function(){
      showQ();
      if(timer) clearInterval(timer);
      timer=setInterval(function(){
        if(!running) return;
        leftSec--; timeEl.textContent=String(leftSec);
        var w=Math.max(0,(leftSec/totalSec)*100); bar.style.width=String(w)+'%';
        if(leftSec<=0){ endRound(); }
      },1000);
    });
  }

  function endRound(){
    running=false; startBtn.disabled=false;
    if(timer){ clearInterval(timer); timer=null; }
    meaning.textContent='ë¼ìš´ë“œ ì¢…ë£Œ! ì ìˆ˜: '+String(score)+' / ë§íŒ: '+String(solved)+' Â· ìŠ¤í‚µ/ì˜¤ë‹µ: '+String(missed);
    var nextLabel = (nextRoundMode==='e2k') ? 'ë‹¤ìŒ ë¼ìš´ë“œ: ëœ» ì“°ê¸°(ì˜â†’í•œ)' : 'ë‹¤ìŒ ë¼ìš´ë“œ: ìŠ¤í  ì“°ê¸°(í•œâ†’ì˜)';
    instruction.textContent= nextLabel + ' â€” â–¶ ì‹œì‘ì„ ëˆ„ë¥´ì„¸ìš”.';
  }

  function submit(){
    if(!running) return;
    var v=String(answer.value||'').trim(); if(!v) return;
    var q=queue[idx];
    var correct=false;

    if(q.mode==='k2e'){
      correct = anyMatchEng(v, q.engPrim, q.engAlts);
    }else{
      correct = anyMatchKor(v, q.korPrim, q.korAlts);
    }

    if(correct){
      score+=1; solved+=1;
      if(q.mode==='k2e'){ speakEnglish(q.engPrim); }
      idx+=1; showQ();
    }else{
      card.classList.remove('shake'); void card.offsetWidth; card.classList.add('shake');
      hint.style.display='block';
      if(q.mode==='k2e'){
        hint.textContent='íŒíŠ¸(ì˜ì–´): '+maskEng(q.engPrim);
      }else{
        var korAll=[q.korPrim].concat(q.korAlts||[]);
        hint.textContent='íŒíŠ¸(í•œêµ­ì–´): '+korAll.join(' / ');
      }
    }
  }

  function skip(){
    if(!running) return;
    missed+=1; idx+=1; showQ();
  }

  function preview(){
    parseBank();
    buildQueue(startModeSel.value || 'e2k');
    idx=0; showQ();
  }

  function peek(){ parseBank(); alert('í˜„ì¬ íŒŒì‹±ëœ í•­ëª© ìˆ˜: '+items.length+'ê°œ'); }

  // EVENTS
  startBtn.addEventListener('click', startRound);
  restartBtn.addEventListener('click', function(){ running=false; if(timer){clearInterval(timer);timer=null;} startRound(); });
  submitBtn.addEventListener('click', submit);
  answer.addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); submit(); } });
  skipBtn.addEventListener('click', skip);
  previewBtn.addEventListener('click', preview);
  applyBtn.addEventListener('click', function(){ parseBank(); alert('ë‹¨ì–´ ë¦¬ìŠ¤íŠ¸ ì ìš© ì™„ë£Œ ('+items.length+'ê°œ)'); });
  peekBtn.addEventListener('click', peek);

  // INIT
  parseBank();
  document.getElementById('progress').textContent='0/'+String(items.length||0);
})();
</script>
</body>
</html>
